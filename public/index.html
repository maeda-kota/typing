<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒˆãƒ«</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #game { display: none; margin-top: 20px; }
    #text { font-size: 18px; margin-bottom: 10px; }
    #input { width: 100%; height: 80px; font-size: 16px; }
    #controls button { margin-right: 10px; }
    #result { font-size: 20px; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

  <!-- ãƒ«ãƒ¼ãƒ é¸æŠï¼ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ -->
  <div id="room-select">
    <div id="controls">
      <label>ãƒ«ãƒ¼ãƒ IDï¼š<input id="roomId" placeholder="ä»»æ„ã®æ–‡å­—åˆ—" /></label>
      <button id="joinBtn">å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰</button>
      <button id="practiceBtn">ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
    </div>
  </div>

  <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
  <div id="game">
    <p id="text"></p>
    <textarea id="input" disabled placeholder="ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"></textarea>
    <div>
      <p>ã‚ãªãŸã®é€²æ—: <span id="myProgress">0%</span></p>
      <p>ç›¸æ‰‹ã®é€²æ—: <span id="oppProgress">0%</span></p>
    </div>
    <p id="result"></p>
  </div>

  <script>
    const socket = io();
    let startTime;
    let isPractice = false;

    // ãƒ†ã‚­ã‚¹ãƒˆä¾‹ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã‚‚ç”¨æ„
    const texts = [
      "é€Ÿãæ­£ç¢ºã«ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã¾ã—ã‚‡ã†ã€‚",
      "Socket.io ã‚’ä½¿ã†ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ãŒç°¡å˜ã§ã™ã€‚",
      "ã‚¿ã‚¤ãƒ—ãƒãƒˆãƒ«ã§å‹åˆ©ã‚’ç›®æŒ‡ãã†ï¼",
      "JavaScript ã§æ¥½ã—ããƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰ï¼"
    ];
    function randomText() {
      return texts[Math.floor(Math.random() * texts.length)];
    }

    // UI è¡¨ç¤ºåˆ‡æ›¿
    function showGame() {
      document.getElementById('room-select').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      document.getElementById('result').textContent = '';
      document.getElementById('oppProgress').textContent = '0%';
      document.getElementById('myProgress').textContent = '0%';
    }

    // å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
    document.getElementById('joinBtn').onclick = () => {
      isPractice = false;
      const roomId = document.getElementById('roomId').value || Date.now().toString();
      socket.emit('join_room', roomId);
      showGame();
    };

    // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
    document.getElementById('practiceBtn').onclick = () => {
      isPractice = true;
      const text = randomText();
      setupPractice(text);
      showGame();
    };

    // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    function setupPractice(text) {
      document.getElementById('text').textContent = text;
      const input = document.getElementById('input');
      input.value = '';
      input.disabled = false;
      input.focus();
      startTime = Date.now();

      // ç·´ç¿’å°‚ç”¨ãƒãƒ³ãƒ‰ãƒ©ã«åˆ‡ã‚Šæ›¿ãˆ
      input.oninput = e => {
        const target = document.getElementById('text').textContent;
        const entered = e.target.value;
        let correct = 0;
        for (let i = 0; i < entered.length; i++) {
          if (entered[i] === target[i]) correct++;
        }
        const progress = Math.floor((correct / target.length) * 100);
        document.getElementById('myProgress').textContent = progress + '%';

        if (progress >= 100) {
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
          document.getElementById('result').textContent = `ç·´ç¿’å®Œäº†ï¼æ‰€è¦æ™‚é–“: ${elapsed} ç§’`;
          input.disabled = true;
        }
      };
    }

    // å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ç”¨å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©ï¼ˆå…±é€šï¼‰
    document.getElementById('input').oninput = e => {
      if (isPractice) return;  // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ç„¡è¦–
      const target = document.getElementById('text').textContent;
      const entered = e.target.value;
      let correct = 0;
      for (let i = 0; i < entered.length; i++) {
        if (entered[i] === target[i]) correct++;
      }
      const progress = Math.floor((correct / target.length) * 100);
      const elapsed = Date.now() - startTime;
      socket.emit('progress', { progress, time: elapsed });
      document.getElementById('myProgress').textContent = progress + '%';
    };

    // å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ï¼šé–‹å§‹ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡
    socket.on('start', ({ text }) => {
      if (isPractice) return;
      document.getElementById('text').textContent = text;
      const input = document.getElementById('input');
      input.value = '';
      input.disabled = false;
      input.focus();
      startTime = Date.now();
    });

    // å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ï¼šé€²æ—æ›´æ–°å—ä¿¡
    socket.on('update', players => {
      if (isPractice) return;
      const opp = players.find(p => p.id !== socket.id);
      if (opp) {
        document.getElementById('oppProgress').textContent = opp.progress + '%';
      }
    });

    // å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ï¼šå‹æ•—åˆ¤å®šå—ä¿¡
    socket.on('finish', ({ winner }) => {
      if (isPractice) return;
      const youWin = winner === socket.id;
      document.getElementById('result').textContent = youWin
        ? 'ğŸ‰ ã‚ãªãŸã®å‹ã¡ï¼'
        : 'ğŸ˜¢ ç›¸æ‰‹ã®å‹ã¡â€¦';
      document.getElementById('input').disabled = true;
    });
  </script>
</body>
</html>
